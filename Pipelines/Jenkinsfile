@Library('gx-library@jalbarellos') _

def projectDefinition = [:]
pipeline {
    agent { node { label 'kbbuilder-node-6' } }
    environment {
        //Boolean forceUpdateGX = false
        String gitUrl = 'https://github.com/genexuslabs/KBBuilder-GeneXusServer.git'
        String gitBranch = 'production' 
        String gitCredentialsId = 'genexuslabs_github' 
        String propertiesFilePath = 'gxserveroperatorsaas-app/build.properties'
        String machineFilePath = 'gxserveroperatorsaas-app/buildernode.properties'
    }
    stages {
        stage('Read Project Properties') {
            steps {
                script {
                    projectDefinition = readPipelineProperties(gitUrl: env.gitUrl, gitBranch: env.gitBranch, gitCredentialsId: env.gitCredentialsId, propertiesFilePath: env.propertiesFilePath, machineFilePath: env.machineFilePath)
                    projectDefinition.forceUpdateGX = false
                }
            }
        }
        stage('Configure GeneXus Installation') {
            steps {
                installGeneXusUsingURI(projectDefinition)
            }
        }
        /*
         stage("Read Environment Properties") {
            environmentDefinition = file.readYamlFile(environmentFile.path)
            String propsFile = genexusTarget.getKBEnvironmentProperties(msbuildExePath, customMSBuildScript, localGXPath, localKBPath, environmentDefinition.name)
            commiteableEnvironmentProp = file.readJsonFile(propsFile)
        }
        stage('Process Reorganization') {
            steps {
                configDefaultDataStore env.projectProps
                /*
                Boolean pendingReorg = checkPendingReorg 
                reorganizeDatabase
                exportReorganization
            }
        }
        /*
        stage('Build KnowledgeBase') {
            steps {
                jobHandleGeneXusInstallation "Calling handle gx instalaltion"
            }
        }
        stage('Execute Unit Tests') {
            steps {
                jobHandleGeneXusInstallation "Calling handle gx instalaltion"
            }
        }
        */
    }
}